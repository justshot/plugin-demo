<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: rtc/stats.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: rtc/stats.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable no-fallthrough */
const MockRTCStatsReport = require('./mockrtcstatsreport');

const ERROR_PEER_CONNECTION_NULL = 'PeerConnection is null';
const ERROR_WEB_RTC_UNSUPPORTED = 'WebRTC statistics are unsupported';
const SIGNED_SHORT = 32767;

// (rrowland) Only needed to detect Chrome so we can force using legacy stats until standard
// stats are fixed in Chrome.
let isChrome = false;
if (typeof window !== 'undefined') {
  const isCriOS = !!window.navigator.userAgent.match('CriOS');
  const isElectron = !!window.navigator.userAgent.match('Electron');
  const isGoogle = typeof window.chrome !== 'undefined'
    &amp;&amp; window.navigator.vendor === 'Google Inc.'
    &amp;&amp; window.navigator.userAgent.indexOf('OPR') === -1
    &amp;&amp; window.navigator.userAgent.indexOf('Edge') === -1;

  isChrome = isCriOS || isElectron || isGoogle;
}

/**
 * @typedef {Object} StatsOptions
 * Used for testing to inject and extract methods.
 * @property {function} [createRTCSample] - Method for parsing an RTCStatsReport
 */
/**
 * Collects any WebRTC statistics for the given {@link PeerConnection}
 * @param {PeerConnection} peerConnection - Target connection.
 * @param {StatsOptions} options - List of custom options.
 * @return {Promise&lt;RTCSample>} Universally-formatted version of RTC stats.
 */
function getStatistics(peerConnection, options) {
  options = Object.assign({
    createRTCSample
  }, options);

  if (!peerConnection) {
    return Promise.reject(new Error(ERROR_PEER_CONNECTION_NULL));
  }

  if (typeof peerConnection.getStats !== 'function') {
    return Promise.reject(new Error(ERROR_WEB_RTC_UNSUPPORTED));
  }

  // (rrowland) Force using legacy stats on Chrome until audioLevel of the outbound
  // audio track is no longer constantly zero.
  if (isChrome) {
    return new Promise((resolve, reject) => peerConnection.getStats(resolve, reject)).then(MockRTCStatsReport.fromRTCStatsResponse)
    .then(options.createRTCSample);
  }

  let promise;
  try {
    promise = peerConnection.getStats();
  } catch (e) {
    promise = new Promise((resolve, reject) => peerConnection.getStats(resolve, reject)).then(MockRTCStatsReport.fromRTCStatsResponse);
  }

  return promise.then(options.createRTCSample);
}

/**
 * @typedef {Object} RTCSample - A sample containing relevant WebRTC stats information.
 * @property {Number} [timestamp]
 * @property {String} [codecName] - MimeType name of the codec being used by the outbound audio stream
 * @property {Number} [rtt] - Round trip time
 * @property {Number} [jitter]
 * @property {Number} [packetsSent]
 * @property {Number} [packetsLost]
 * @property {Number} [packetsReceived]
 * @property {Number} [bytesReceived]
 * @property {Number} [bytesSent]
 * @property {Number} [localAddress]
 * @property {Number} [remoteAddress]
 * @property {Number} [audioInputLevel] - Between 0 and 32767
 * @property {Number} [audioOutputLevel] - Between 0 and 32767
 */
function RTCSample() { }

/**
 * Create an RTCSample object from an RTCStatsReport
 * @private
 * @param {RTCStatsReport} statsReport
 * @returns {RTCSample}
 */
function createRTCSample(statsReport) {
  let activeTransportId = null;
  const sample = new RTCSample();
  let fallbackTimestamp;

  Array.from(statsReport.values()).forEach(stats => {
    // Skip isRemote tracks which will be phased out completely and break in FF66.
    if (stats.isRemote) { return; }

    // Firefox hack -- Older firefox doesn't have dashes in type names
    const type = stats.type.replace('-', '');

    fallbackTimestamp = fallbackTimestamp || stats.timestamp;

    // (rrowland) As I understand it, this is supposed to come in on remote-inbound-rtp but it's
    // currently coming in on remote-outbound-rtp, so I'm leaving this outside the switch until
    // the appropriate place to look is cleared up.
    if (stats.remoteId) {
      const remote = statsReport.get(stats.remoteId);
      if (remote &amp;&amp; remote.roundTripTime) {
        sample.rtt = remote.roundTripTime;
      }
    }

    switch (type) {
      case 'inboundrtp':
        sample.timestamp = sample.timestamp || stats.timestamp;
        sample.jitter = stats.jitter * 1000;
        sample.packetsLost = stats.packetsLost;
        sample.packetsReceived = stats.packetsReceived;
        sample.bytesReceived = stats.bytesReceived;

        const inboundTrack = statsReport.get(stats.trackId);
        if (inboundTrack) {
          sample.audioOutputLevel = inboundTrack.audioLevel * SIGNED_SHORT;
        }
        break;
      case 'outboundrtp':
        sample.timestamp = stats.timestamp;
        sample.packetsSent = stats.packetsSent;
        sample.bytesSent = stats.bytesSent;

        if (stats.codecId &amp;&amp; statsReport.get(stats.codecId)) {
          const mimeType = statsReport.get(stats.codecId).mimeType;
          sample.codecName = mimeType &amp;&amp; mimeType.match(/(.*\/)?(.*)/)[2];
        }

        const outboundTrack = statsReport.get(stats.trackId);
        if (outboundTrack) {
          sample.audioInputLevel = outboundTrack.audioLevel * SIGNED_SHORT;
        }
        break;
      case 'transport':
        if (stats.dtlsState === 'connected') {
          activeTransportId = stats.id;
        }
        break;
    }
  });

  if (!sample.timestamp) {
    sample.timestamp = fallbackTimestamp;
  }

  const activeTransport = statsReport.get(activeTransportId);
  if (!activeTransport) { return sample; }

  const selectedCandidatePair = statsReport.get(activeTransport.selectedCandidatePairId);
  if (!selectedCandidatePair) { return sample; }

  const localCandidate = statsReport.get(selectedCandidatePair.localCandidateId);
  const remoteCandidate = statsReport.get(selectedCandidatePair.remoteCandidateId);

  if (!sample.rtt) {
    sample.rtt = selectedCandidatePair &amp;&amp; (selectedCandidatePair.currentRoundTripTime * 1000);
  }

  Object.assign(sample, {
    localAddress: localCandidate &amp;&amp; localCandidate.ip,
    remoteAddress: remoteCandidate &amp;&amp; remoteCandidate.ip,
  });

  return sample;
}

module.exports = getStatistics;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Exception.html">Exception</a></li><li><a href="module-mixinLog.html">mixinLog</a></li></ul><h3>Classes</h3><ul><li><a href="EventPublisher.html">EventPublisher</a></li><li><a href="MockRTCStatsReport.html">MockRTCStatsReport</a></li><li><a href="PeerConnection.html">PeerConnection</a></li><li><a href="PStream.html">PStream</a></li><li><a href="RTCMonitor.html">RTCMonitor</a></li><li><a href="Sound.html">Sound</a></li></ul><h3>Global</h3><ul><li><a href="global.html#calcMos">calcMos</a></li><li><a href="global.html#convertMsToSeconds">convertMsToSeconds</a></li><li><a href="global.html#createRTCCertificateStats">createRTCCertificateStats</a></li><li><a href="global.html#createRTCCodecStats">createRTCCodecStats</a></li><li><a href="global.html#createRTCDataChannelStats">createRTCDataChannelStats</a></li><li><a href="global.html#createRTCIceCandidatePairStats">createRTCIceCandidatePairStats</a></li><li><a href="global.html#createRTCIceCandidateStats">createRTCIceCandidateStats</a></li><li><a href="global.html#createRTCInboundRTPStreamStats">createRTCInboundRTPStreamStats</a></li><li><a href="global.html#createRTCMediaStreamTrackStats">createRTCMediaStreamTrackStats</a></li><li><a href="global.html#createRTCOutboundRTPStreamStats">createRTCOutboundRTPStreamStats</a></li><li><a href="global.html#createRTCRTPStreamStats">createRTCRTPStreamStats</a></li><li><a href="global.html#createRTCTransportStats">createRTCTransportStats</a></li><li><a href="global.html#getStatistics">getStatistics</a></li><li><a href="global.html#MediaDevicesShim">MediaDevicesShim</a></li><li><a href="global.html#Request">Request</a></li><li><a href="global.html#setAudioSource">setAudioSource</a></li><li><a href="global.html#translateCandidateType">translateCandidateType</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Feb 21 2019 18:36:56 GMT+0000 (UTC)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
